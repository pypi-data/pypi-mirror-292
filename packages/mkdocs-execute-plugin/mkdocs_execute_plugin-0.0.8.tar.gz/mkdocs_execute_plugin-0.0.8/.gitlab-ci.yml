image: python:3.8
stages:
  - test

run tests:
  stage: test
  script:
    - pip install .
    - pip install pytest mkdocs==1.5.3
    - py.test

publish to test pypi:
  needs:
    - run tests
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+.*\+test$/' # vX.Y.Z.post1+test
  script:
    - pip install hatch hatch-vcs
    - hatch build
    - hatch publish -u __token__ -a $PYPI_TEST_TOKEN -r test

publish to pypi:
  needs:
    - run tests
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+[^+]*$/' # No +test
  script:
    - pip install hatch hatch-vcs
    - hatch build
    - hatch publish -u __token__ -a $PYPI_TOKEN
