"use strict";(self.webpackChunkneopyter=self.webpackChunkneopyter||[]).push([[608],{4608:(e,t,o)=>{o.r(t),o.d(t,{default:()=>W});var n=o(7909),r=o(9480),s=o(8456),a=o(4614),l=o(314),i=o(8502),c=o(7460),d=o(3345),u=o.n(d),h=o(4497),p=o(3745),g=o(9003),m=o.n(g),y=o(7356),f=o(9207);function v(e,t){let o;try{o=e()}catch(e){return}return{getItem:e=>{var n;const r=e=>null===e?null:JSON.parse(e,null==t?void 0:t.reviver),s=null!=(n=o.getItem(e))?n:null;return s instanceof Promise?s.then(r):r(s)},setItem:(e,n)=>o.setItem(e,JSON.stringify(n,null==t?void 0:t.replacer)),removeItem:e=>o.removeItem(e)}}const b=e=>t=>{try{const o=e(t);return o instanceof Promise?o:{then:e=>b(e)(o),catch(e){return this}}}catch(e){return{then(e){return this},catch:t=>b(t)(e)}}},w=e=>e.charAt(0).toUpperCase()+e.slice(1);var k,S;!function(e){e.direct="direct",e.proxy="proxy"}(k||(k={})),function(e){e.info="info",e.warn="warn",e.debug="debug",e.error="error"}(S||(S={}));var C=o(7354),R=o(1473);const E=(...e)=>{T.getState().loglevel===S.info&&console.log(...e)},x=(...e)=>{console.error(...e)};var N=o(5473);class M extends Error{constructor(e){super(e),this.name="RPCError"}}const $="https://github.com/msgpack-rpc/msgpack-rpc/blob/master/spec.md";var I;!function(e){e[e.Request=0]="Request",e[e.Response=1]="Response",e[e.Notification=2]="Notification"}(I||(I={}));class O{constructor(e){this.dispatcher=e}start(e,...t){this.transport=new e(this,...t)}async dispatchMethod(e,t){if(!this.dispatcher[e.method]){const o=new M(`Method not found ${e.method}`);throw e.type===I.Request&&t&&t({type:I.Response,msgid:e.msgid,error:o,result:void 0}),o}try{const o=await this.dispatcher[e.method](...e.params);e.type===I.Request&&t&&t({type:I.Response,msgid:e.msgid,result:o})}catch(o){console.error(o),e.type===I.Request&&t&&t({type:I.Response,msgid:e.msgid,error:o})}}}class P{constructor(e){this.server=e}async onRequest(e){await this.server.dispatchMethod(e,(e=>{this.sendData(function(e){return e.type===I.Request?(0,N.encode)([e.type,e.msgid,e.method,e.params]):e.type===I.Response?(0,N.encode)([e.type,e.msgid,e.error?e.error.toString():void 0,e.result]):(0,N.encode)([e.type,e.method,e.params])}(e))}))}async onNotify(e){this.server.dispatchMethod(e)}}class _ extends P{constructor(e,t,o){super(e),this.url=t,this.autoRetry=o,this.start()}async start(){try{this.websocket=new WebSocket(this.url),this.websocket.binaryType="arraybuffer",this.readableStream=new ReadableStream({start:e=>{this.websocket.addEventListener("open",(e=>{this.onOpen(e)})),this.websocket.addEventListener("message",(t=>{const o=function(e){const t=atob(e);return Uint8Array.from(t,(e=>e.codePointAt(0)))}(t.data);e.enqueue(o)})),this.websocket.addEventListener("error",(e=>{throw this.onError(e),e})),this.websocket.addEventListener("close",(t=>{this.onClose(t),e.close()}))}});for await(const e of async function*(e){const t=(0,N.decodeMultiStream)(e);for await(const e of t){if(!Array.isArray(e)||4!==e.length&&3!==e.length)throw new M(`Invalid msgpack-rpc message: ${JSON.stringify(e)}, please reference ${$}`);const t=e[0];if(0!==t&&1!==t&&2!==t)throw new M(`Invalid msgpack-rpc message: ${JSON.stringify(e)}, please reference ${$}`);t===I.Request?yield{type:I.Request,msgid:e[1],method:e[2],params:e[3]}:t===I.Response?yield{type:I.Response,msgid:e[1],error:e[2],result:e[3]}:yield{type:I.Notification,method:e[1],params:e[2]}}}(this.readableStream))E(e),this.onRead(e)}catch(e){throw x(e),this.checkRetry(),e}}async onRead(e){switch(e.type){case I.Request:await this.onRequest(e);break;case I.Notification:await this.onNotify(e);break;default:throw new M(`unknown message: ${e}`)}}sendData(e){this.websocket.send(function(e){const t=String.fromCodePoint(...e);return btoa(t)}(e))}onOpen(e){E(`connection websocket ${this.websocket.url}`)}onError(e){x("websocket error",e)}onClose(e){E(`disconnect websocket: ${this.websocket.url}`,e),this.websocket.close(),this.websocket=void 0,this.readableStream=void 0,this.checkRetry()}checkRetry(){this.autoRetry&&void 0===this.websocket&&(E("reconnect websocket server after 1s"),setTimeout((()=>{this.autoRetry&&void 0===this.websocket?this.start():console.error("check reconnect repeat")}),1e3))}}const z=(0,f.create)()((j=(e,t)=>({mode:"direct",ip:"127.0.0.1",port:9001,loglevel:S.error}),"getStorage"in(F={name:"neopyter-setting"})||"serialize"in F||"deserialize"in F?(console.warn("[DEPRECATED] `getStorage`, `serialize` and `deserialize` options are deprecated. Use `storage` option instead."),((e,t)=>(o,n,r)=>{let s={getStorage:()=>localStorage,serialize:JSON.stringify,deserialize:JSON.parse,partialize:e=>e,version:0,merge:(e,t)=>({...t,...e}),...t},a=!1;const l=new Set,i=new Set;let c;try{c=s.getStorage()}catch(e){}if(!c)return e(((...e)=>{console.warn(`[zustand persist middleware] Unable to update item '${s.name}', the given storage is currently unavailable.`),o(...e)}),n,r);const d=b(s.serialize),u=()=>{const e=s.partialize({...n()});let t;const o=d({state:e,version:s.version}).then((e=>c.setItem(s.name,e))).catch((e=>{t=e}));if(t)throw t;return o},h=r.setState;r.setState=(e,t)=>{h(e,t),u()};const p=e(((...e)=>{o(...e),u()}),n,r);let g;const m=()=>{var e;if(!c)return;a=!1,l.forEach((e=>e(n())));const t=(null==(e=s.onRehydrateStorage)?void 0:e.call(s,n()))||void 0;return b(c.getItem.bind(c))(s.name).then((e=>{if(e)return s.deserialize(e)})).then((e=>{if(e){if("number"!=typeof e.version||e.version===s.version)return e.state;if(s.migrate)return s.migrate(e.state,e.version);console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}})).then((e=>{var t;return g=s.merge(e,null!=(t=n())?t:p),o(g,!0),u()})).then((()=>{null==t||t(g,void 0),a=!0,i.forEach((e=>e(g)))})).catch((e=>{null==t||t(void 0,e)}))};return r.persist={setOptions:e=>{s={...s,...e},e.getStorage&&(c=e.getStorage())},clearStorage:()=>{null==c||c.removeItem(s.name)},getOptions:()=>s,rehydrate:()=>m(),hasHydrated:()=>a,onHydrate:e=>(l.add(e),()=>{l.delete(e)}),onFinishHydration:e=>(i.add(e),()=>{i.delete(e)})},m(),g||p})(j,F)):((e,t)=>(o,n,r)=>{let s={storage:v((()=>localStorage)),partialize:e=>e,version:0,merge:(e,t)=>({...t,...e}),...t},a=!1;const l=new Set,i=new Set;let c=s.storage;if(!c)return e(((...e)=>{console.warn(`[zustand persist middleware] Unable to update item '${s.name}', the given storage is currently unavailable.`),o(...e)}),n,r);const d=()=>{const e=s.partialize({...n()});return c.setItem(s.name,{state:e,version:s.version})},u=r.setState;r.setState=(e,t)=>{u(e,t),d()};const h=e(((...e)=>{o(...e),d()}),n,r);let p;r.getInitialState=()=>h;const g=()=>{var e,t;if(!c)return;a=!1,l.forEach((e=>{var t;return e(null!=(t=n())?t:h)}));const r=(null==(t=s.onRehydrateStorage)?void 0:t.call(s,null!=(e=n())?e:h))||void 0;return b(c.getItem.bind(c))(s.name).then((e=>{if(e){if("number"!=typeof e.version||e.version===s.version)return[!1,e.state];if(s.migrate)return[!0,s.migrate(e.state,e.version)];console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}return[!1,void 0]})).then((e=>{var t;const[r,a]=e;if(p=s.merge(a,null!=(t=n())?t:h),o(p,!0),r)return d()})).then((()=>{null==r||r(p,void 0),p=n(),a=!0,i.forEach((e=>e(p)))})).catch((e=>{null==r||r(void 0,e)}))};return r.persist={setOptions:e=>{s={...s,...e},e.storage&&(c=e.storage)},clearStorage:()=>{null==c||c.removeItem(s.name)},getOptions:()=>s,rehydrate:()=>g(),hasHydrated:()=>a,onHydrate:e=>(l.add(e),()=>{l.delete(e)}),onFinishHydration:e=>(i.add(e),()=>{i.delete(e)})},s.skipHydration||g(),p||h})(j,F))),A={notifyJupyterServer:async()=>{const e=JSON.stringify(T.getState());E("notify jupyter server, send:",e);const t=C.ServerConnection.makeSettings(),o=t.baseUrl,n=R.URLExt.join(o,"neopyter","update_settings"),r=await C.ServerConnection.makeRequest(n,{method:"POST",body:e},t);E("notify jupyter server, receive:",await r.json())},startConnection:async e=>{E("start connecting..");const t=new O(e),{mode:o,ip:n,port:r}=T.getState();if(E(`current mode: ${o}`),await T.notifyJupyterServer(),"proxy"===o){const e=C.ServerConnection.makeSettings(),o=R.URLExt.join(e.wsUrl,"neopyter","channel");console.info(`neopyter connect to:${o}`),t.start(_,o,!1)}else{const e=`ws://${n}:${r}`;console.info(`neopyter connect to:${e}`),t.start(_,e,!0)}},updateSettings:async e=>{z.setState(e),T.notifyJupyterServer()}},T=((e,t)=>{const o=e;for(const e of Object.keys(t)){const n=o;if(n[e])throw`The key ${e} already exists in store`;n[e]=t[e]}return o})((e=>{const t=e,o=t;for(const e of Object.keys(t.getState())){const n=`set${w(e)}`;if(o[n])throw`exists same key [${n}] in ${t}`;o[n]=o=>{"function"==typeof o?t.setState((t=>Object.fromEntries([[e,o(t[e])]]))):t.setState(Object.fromEntries([[e,o]]))}}return t})((e=>{const t=e,o=t;for(const e of Object.keys(t.getState())){const n=`use${w(e)}`;if(o[n])throw`exists same key [${n}] in ${t}`;o[n]=()=>t((t=>t[e]))}return t})(z)),A),q=(0,h.withTheme)(p.Theme),J=()=>{const[e,t]=(0,d.useState)(void 0),n=T();(0,d.useEffect)((()=>{(async()=>{const e=await o.e(186).then(o.t.bind(o,9186,19));t(e)})()}),[]);const r=(0,d.useCallback)((async({formData:e})=>{E("save settings: ",JSON.stringify(e)),T.updateSettings(e)}),[]);return u().createElement(u().Fragment,null,e?u().createElement(q,{schema:e,validator:m(),formData:n,onSubmit:r},u().createElement(y.Tooltip,{title:"Please reload web page after saved"},u().createElement(y.Button,{type:"primary",htmlType:"submit",style:{left:"50%",position:"relative"}},"Save"))):void 0)};var j,F;class L extends c.SidePanel{constructor(){super(),this.id="neopyter-status-sidepanel";const e=c.ReactWidget.create(u().createElement(J,null));e.title.label="Neopyter Settings",this.content.addWidget(e)}}const U=new c.LabIcon({name:"neopyter:status-page",svgstr:'<svg t="1704342603868" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1462" width="200" height="200"><path d="M512.416 409.472a239.914667 239.914667 0 1 1 0 479.786667 239.914667 239.914667 0 0 1 0-479.786667zM6.645333 371.925333l128.853334 152.490667a27.264 27.264 0 0 0 38.954666 2.901333c208.426667-186.837333 468.053333-186.837333 675.84 0a27.392 27.392 0 0 0 39.082667-2.901333l128.256-152.490667a27.562667 27.562667 0 0 0-3.2-38.656c-302.933333-264.704-702.378667-264.704-1005.013333 0a27.733333 27.733333 0 0 0-2.773334 38.656z" p-id="1463"></path></svg>\n'}),W=[{id:"neopyter:labplugin",description:"A JupyterLab extension.",autoStart:!0,requires:[n.ILabShell,s.IDocumentManager,r.INotebookTracker,n.ILayoutRestorer,a.ISettingRegistry,l.ICompletionProviderManager],activate:(e,t,n,s,a,l,c)=>{const d=c.getProviders();console.log("JupyterLab extension neopyter is activated!");const u=d.get("CompletionProvider:kernel"),h=new L;h.title.caption="Neopyter",h.title.icon=U,e.shell.add(h,"right"),a&&a.add(h,"@neopyter/graphsidebar");const p=e=>{var o;let r;e&&(r=n.findWidget(e));let s=null==r?void 0:r.content;if(!s){const e=t.currentWidget;(null==e?void 0:e.isUntitled)&&(r=e,s=r.content)}const a=null===(o=null==s?void 0:s.model)||void 0===o?void 0:o.sharedModel;if(!r||!a||!s)throw`Don't open ${e} and current don't select untitled ipynb`;return{notebookPanel:r,notebook:s,sharedModel:a}},g=(e,t)=>{const{notebook:o,sharedModel:n}=p(e),r=n.getCell(t);return{notebook:o,sharedNotebookModel:n,sharedModel:r}},m={getVersion:async()=>(await o.e(330).then(o.t.bind(o,8330,19))).version,echo:e=>`hello: ${e}`,executeCommand:async(t,o)=>{await e.commands.execute(t,o)}},y={getCurrentNotebook:()=>{const e=t.currentWidget;if(e){const t=n.contextForWidget(e);return null==t?void 0:t.localPath}},isFileOpen:e=>!!n.findWidget(e),isFileExist:async e=>{try{return!!await n.services.contents.get(e)}catch(e){return!1}},createNew:(e,t,o)=>n.createNew(e,t,o),openFile:e=>!!n.open(e),openOrReveal:e=>!!n.openOrReveal(e),activateNotebook:e=>{const{notebookPanel:o}=p(e);t.activateById(o.id),o.activate();const n=e=>{const t=new FocusEvent("focus",{bubbles:!0,cancelable:!0,view:window});e.click(),e.dispatchEvent(t),e.focus(),function(e){const t="onfocusin"in e?"focusin":"focus",o="onfocusin"in e;let n;"createEvent"in document?(n=document.createEvent("Event"),n.initEvent(t,o,!0)):"Event"in window&&(n=new Event(t,{bubbles:o,cancelable:!0})),e.focus(),e.dispatchEvent(n)}(e)},r=t._dockPanel;for(const e of r.tabBars()){const t=e.titles.findIndex((e=>e.owner===o));if(t>=0){n(e.contentNode.children[t]);break}}n(o.node)},closeFile:async e=>await n.closeFile(e),selectAbove:()=>{const{notebook:e}=p();e&&r.NotebookActions.selectBelow(e)},selectBelow:()=>{const{notebook:e}=p();e&&r.NotebookActions.selectBelow(e)}},f={getCellNum:e=>p(e).sharedModel.cells.length,setCellNum:(e,t)=>{const{notebook:o,sharedModel:n}=p(e),r=n.cells.length;if(t>r)n.insertCells(r,i.range(0,t-r).map((()=>({cell_type:o.notebookConfig.defaultCell,metadata:"code"===o.notebookConfig.defaultCell?{trusted:!0}:{}}))));else for(;t<n.cells.length;)n.deleteCell(n.cells.length-1)},getCell:(e,t)=>{const{sharedModel:o}=g(e,t);return o.toJSON()},deleteCell:(e,t)=>p(e).sharedModel.deleteCell(t),insertCell:(e,t)=>{const{notebook:o,sharedModel:n}=p(e);return n.insertCell(t,{cell_type:o.notebookConfig.defaultCell,metadata:"code"===o.notebookConfig.defaultCell?{trusted:!0}:{}})},activateCell:(e,t)=>{const{notebook:o}=p(e);o.activeCellIndex=t},scrollToItem:(e,t,o,n)=>{const{notebook:r}=p(e);r.scrollToItem(t,o,n)},fullSync:(e,t)=>{const{notebook:o,sharedModel:n}=p(e);for(t.forEach(((e,t)=>{const r=n.getCell(t);r?void 0===e.cell_type||r.cell_type===e.cell_type?r.setSource(e.source):(n.deleteCell(t),n.insertCell(t,{cell_type:e.cell_type,source:e.source,metadata:r.getMetadata()})):n.insertCell(t,{cell_type:e.cell_type,source:e.source,metadata:"code"===o.notebookConfig.defaultCell?{trusted:!0}:{}})}));t.length<n.cells.length;)n.deleteCell(n.cells.length-1)},partialSync:(e,t,o,n)=>{const{notebook:r,sharedModel:s}=p(e);for(console.log(`partialSync: current cell num:${s.cells.length}, from:${t}(include), to:${o}(include), update to cell num:${n.length}`),n.forEach(((e,n)=>{const a=n+t,l=s.getCell(a);a<=o&&l?void 0===e.cell_type||l.cell_type===e.cell_type?l.setSource(e.source):(s.deleteCell(a),s.insertCell(a,{cell_type:e.cell_type,source:e.source,metadata:l.getMetadata()})):s.insertCell(a,{cell_type:e.cell_type,source:e.source,metadata:"code"===r.notebookConfig.defaultCell?{trusted:!0}:{}})}));o-t+1>n.length;)s.deleteCell(o),o-=1},save:async e=>{const{notebookPanel:t}=p(e),o=n.contextForWidget(t);return null==o||o.path,await(null==o?void 0:o.save())},runSelectedCell:async t=>await e.commands.execute("notebook:run-cell"),runAllAbove:async t=>await e.commands.execute("notebook:run-all-above"),runAllBelow:async t=>await e.commands.execute("notebook:run-all-below"),runAll:async t=>await e.commands.execute("notebook:run-all-cells"),restartKernel:async e=>{const{notebookPanel:t}=p(e);return await t.sessionContext.restartKernel()},restartRunAll:async t=>{const{notebookPanel:o}=p(t);return await o.sessionContext.restartKernel(),await e.commands.execute("notebook:run-all-cells")},setMode:(e,t)=>{const{notebookPanel:o}=p(e);o.content.mode=t},kernelComplete:async(e,t,o)=>{const{notebookPanel:n}=p(e);console.log("kernelComplete:",t,o);const r=await u.fetch({text:t,offset:o},{widget:n,session:n.sessionContext.session});return console.log(r),r.items.map((({type:e,label:t,insertText:o})=>({type:e,label:t,insertText:o})))}},v={setCellSource:(e,t,o)=>{const{sharedModel:n}=g(e,t);n.setSource(o)},setCellType:(e,t,o)=>{const{sharedNotebookModel:n,sharedModel:r}=g(e,t);r.cell_type!==o&&(n.deleteCell(t),n.insertCell(t,{cell_type:o,source:r.getSource(),metadata:r.getMetadata()}))}};Object.assign(m,y),Object.assign(m,f),Object.assign(m,v),T.startConnection(m)}}]}}]);