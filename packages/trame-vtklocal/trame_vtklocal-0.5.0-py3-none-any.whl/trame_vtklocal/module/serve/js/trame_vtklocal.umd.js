(function(m,a){typeof exports=="object"&&typeof module<"u"?a(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],a):(m=typeof globalThis<"u"?globalThis:m||self,a(m.trame_vtklocal={},m.Vue))})(this,function(m,a){"use strict";async function E(s,i){const l={canvas:s,locateFile(){return i},print(){console.info(Array.prototype.slice.call(arguments).join(" "))},printErr(){console.error(Array.prototype.slice.call(arguments).join(" "))}},w=await window.createVTKWasmSceneManager(l);return w.initialize(),w}function R(s,i){return s.updateStateFromObject(i),s.getState(i)}function U(s,i,l){return function(){for(const[w,p]of Object.entries(l)){const f={};for(const[S,b]of Object.entries(p)){const u=R(i,S);if(typeof b=="string")f[b]=u;else for(const[h,d]of Object.entries(b))f[d]=u[h]}s.state.set(w,f)}}}const W={VtkLocal:{emits:["updated","memory-vtk","memory-arrays","camera"],props:{renderWindow:{type:Number},eagerSync:{type:Boolean,default:!1},cacheSize:{type:Number,default:1e8},wsClient:{type:Object},listeners:{type:Object}},setup(s,{emit:i}){const l=a.inject("trame"),w=l.state.get("__trame_vtklocal_wasm_url"),p=[],f=[],S=a.ref(null),b=a.ref(null),u=s.wsClient||(l==null?void 0:l.client),h={},d={},T={},v=a.ref(1);let t=null,M=0,j=null;function z([e]){if(e.type==="state"){const{mtime:r,content:o,id:n}=e;t.unRegisterState(n),t.registerState(o),h[n]=r}if(e.type==="blob"){const{hash:r,content:o}=e;T[r]=new Promise(n=>{o.arrayBuffer?o.arrayBuffer().then(c=>{t.registerBlob(r,new Uint8Array(c)),n()}):(t.registerBlob(r,o),n())})}}async function A(){const e=u.getConnection().getSession();j=e.subscribe("vtklocal.subscriptions",z),await e.call("vtklocal.subscribe.update",[s.renderWindow,1])}async function V(){const e=u.getConnection().getSession();j&&(e.unsubscribe(j),j=null),await e.call("vtklocal.subscribe.update",[s.renderWindow,-1])}function C(){const{width:e,height:r}=S.value.getBoundingClientRect(),o=Math.floor(e*window.devicePixelRatio+.5),n=Math.floor(r*window.devicePixelRatio+.5),c=a.unref(b);c&&t&&s.renderWindow&&(c.width=o,c.height=n,t.setSize(s.renderWindow,o,n),t.render(s.renderWindow))}let O=new ResizeObserver(C);async function _(e){const o=await u.getConnection().getSession().call("vtklocal.get.state",[e]);return o.length>0?(h[e]=JSON.parse(o).MTime,t.unRegisterState(e),t.registerState(o)):console.log(`Server returned empty state for ${e}`),o}async function P(e){if(T[e]){await T[e],d[e]=a.unref(v),delete T[e];return}const o=await u.getConnection().getSession().call("vtklocal.get.hash",[e]),n=o.arrayBuffer?new Uint8Array(await o.arrayBuffer()):o;return t.registerBlob(e,n),d[e]=a.unref(v),n}function F(){const e=t.getTotalVTKDataObjectMemoryUsage(),r=t.getTotalBlobMemoryUsage(),o=Number(s.cacheSize)+e;if(r>o){const n={};let c=a.unref(v);for(Object.entries(d).forEach(([y,g])=>{g<c&&(c=g);const k=g.toString();n[k]?n[k].push(y):n[k]=[y]});t.getTotalBlobMemoryUsage()>o;){const y=n[c];if(y)for(let g=0;g<y.length;g++)t.unRegisterBlob(y[g]),delete d[y[g]];c++}}i("memory-vtk",t.getTotalVTKDataObjectMemoryUsage()),i("memory-arrays",t.getTotalBlobMemoryUsage())}async function B(){if(M++,M===1)try{const r=await u.getConnection().getSession().call("vtklocal.get.status",[s.renderWindow]),o=[];r.ids.forEach(([n,c])=>{(!h[n]||h[n]<c)&&o.push(_(n))}),p.push(...r.cameras),r.ignore_ids.forEach(n=>{t.unRegisterState(n)}),r.hashes.forEach(n=>{d[n]||o.push(P(n)),d[n]=a.unref(v)}),await Promise.all(o),v.value++;try{t.updateObjectsFromStates(),t.render(s.renderWindow),C()}catch(n){console.error("WASM update failed"),console.log(n)}i("updated"),F()}catch(e){console.error("Error in update",e)}finally{M--,M&&(M=0,await B())}}function L(e){t.resetCamera(e),t.render(s.renderWindow)}return a.onMounted(async()=>{t=await E(a.unref(b),w),s.eagerSync&&A(),await B();for(let e=0;e<p.length;e++){const r=p[e];f.push([r,t.addObserver(r,"ModifiedEvent",()=>{t.updateStateFromObject(r);const o=t.getState(r);i("camera",o)})])}for(const[e,r]of Object.entries(s.listeners||{}))for(const[o,n]of Object.entries(r||{}))f.push([e,t.addObserver(e,o,U(l,t,n))]);t.startEventLoop(s.renderWindow),O&&O.observe(a.unref(S))}),a.onBeforeUnmount(()=>{for(j&&V();f.length;){const[e,r]=f.pop();t.removeObserver(e,r)}t.stopEventLoop(s.renderWindow),O&&(O.disconnect(),O=null)}),{container:S,canvas:b,update:B,resetCamera:L}},template:`
        <div ref="container" style="position: relative; width: 100%; height: 100%;">
          <canvas 
            id="canvas"
            ref="canvas" 
            style="position: absolute; left: 0; top: 0; width: 100%; height: 100%;" 
            tabindex="0"
            
            @contextmenu.prevent
            @click="canvas.focus()"
            @mouseenter="canvas.focus()"
          />
        </div>`}};function x(s){Object.keys(W).forEach(i=>{s.component(i,W[i])})}m.install=x,Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});
