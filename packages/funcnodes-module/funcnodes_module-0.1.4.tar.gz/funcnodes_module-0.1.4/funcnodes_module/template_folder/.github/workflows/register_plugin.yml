# this is an autogenerated file, do not edit it directly or your changes might be lost.
name: Create Plugin Submission Issue

on:
  push:
    tags:
      - "v*" # This triggers the workflow when a new version tag is pushed
    branches:
      - main
  workflow_dispatch:

jobs:
  create-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the code
        uses: actions/checkout@v4

      - name: Install Package
        uses: ./.github/actions/install_package

      - name: check_package
        run: |
          pip install funcnodes-module --upgrade
          funcnodes-module check_for_register
          PACKAGE_NAME=$(poetry version | awk '{print $1}')
          PYPI_NAME=$(curl -s https://pypi.org/pypi/$PACKAGE_NAME/json | jq -r .info.name)
          echo "PYPI_NAME=${PYPI_NAME}" >> $GITHUB_ENV

      - name: Create GitHub Issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REGISTRY_REPO: "Linkdlab/funcnodes_repositories" # Replace with your registry repo
        run: |
          REPOSITORY_URL=$(git config --get remote.origin.url)

          ISSUE_TITLE="[Plugin Submission] $PYPI_NAME"
          ISSUE_BODY="\
          A new plugin has been submitted.\n\n\
          **Package Name**: $PYPI_NAME\n\
          **Repository**: $REPOSITORY_URL\n\n\
          Please review and merge the plugin into the registry."

          curl -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               --request POST \
               --data "{ \"title\": \"$ISSUE_TITLE\", \"body\": \"$ISSUE_BODY\", \"labels\": [\"plugin-submission\"] }" \
               https://api.github.com/repos/$REGISTRY_REPO/issues
