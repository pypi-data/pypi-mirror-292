var K=4,ae=4,D=9,de=16,ie=200,Q=12,ce=1e3;var q=25;var le=.1;var M="Node data provider: ",R=10;var k="__value",j="__tensor_tag",P=20;var Ae=new OffscreenCanvas(300,300),pe={},Et=typeof navigator<"u"&&/Macintosh/.test(navigator.userAgent);function T(s){return s?.nodeType===0}function N(s){return s?.nodeType===1}function z(s){let e=[];for(let[o,t]of Object.entries(s))switch(o){case"Op node id":t.selected&&e.push("id");break;default:break}return e}function Z(s){let e=[];for(let[o,t]of Object.entries(s))switch(o){case"Layer node children count":t.selected&&e.push("#children");break;case"Layer node descendants count":t.selected&&e.push("#descendants");break;default:break}return e}function J(s,e){if(T(s))switch(e.toLowerCase()){case"id":return s.id;case"namespace":return ue(s);default:break}else if(N(s))switch(e.toLowerCase()){case"namespace":return ue(s);case"#children":return String((s.nsChildrenIds||[]).length);case"#descendants":return String((s.descendantsNodeIds||[]).length);default:break}return""}function ue(s){return s.savedNamespace||s.namespace||"<root>"}function A(s,e,o){let t=[];s==null?t=e.rootNodes.map(r=>r.id):t=s.nsChildrenIds||[];for(let r of t){let n=e.nodesById[r];n&&N(n)&&n.expanded&&((n.nsChildrenIds||[]).filter(a=>N(e.nodesById[a])).every(a=>!e.nodesById[a].expanded)&&o.push(n.id),A(n,e,o))}}function he(s,e,o,t){let r=[];if(s.length===2)r=s;else if(s.length===3&&s[0].x===s[1].x&&s[1].x===s[2].x)r=s;else{let n=!0,d=0;for(let i=0;i<s.length-1;i++){let c=s[i],f=s[i+1]>c?1:-1;if(d!==0&&d!==f){n=!1;break}d=f}let a=t.Vector3;if(n){let c=e().x(p=>p.x).y(p=>p.y).curve(o)(s).split(/M|C/).filter(p=>p!=="").map(p=>p.split(",").map(u=>Number(u))),l=new a(c[0][0],c[0][1],0),f=new t.CurvePath;for(let p=1;p<c.length;p++){let u=c[p];if(u.length===6){let m=l,_=new a(u[0],u[1]),h=new a(u[2],u[3]),E=new a(u[4],u[5]);l=E;let I=new t.CubicBezierCurve3(m,_,h,E);f.add(I)}}r=f.getPoints(q)}else{let i=s.map(l=>new a(l.x,l.y,0));r=new t.CatmullRomCurve3(i,!1,"catmullrom",le).getPoints(q)}}return r}function G(s,e,o,t=!0){let r=`${s}___${e}___${o}`,n=pe[r];if(n==null){let d=Ae.getContext("2d");d.font=`${e}px "Google Sans Text", Arial, Helvetica, sans-serif`,o&&(d.font=`bold ${d.font}`);let i=d.measureText(s).width;t&&(pe[r]=i),n=i}return n}function Ge(s,e,o){let t=o[j];return t?`Input${s}:${t} (${e.label})`:`Input${s} (${e.label})`}function xe(s,e,o){let t=`Output${s}`;if(o.label==="GraphInputs"){let r=e.tensor_name;r!=null&&(t=`${t} (${r})`)}else{let r=e[j];r&&(t=`Output${s}:${r}`)}return t}function fe(s){let e=((s||{}).shape||"").replace(/ /g,"").replace(/Ã—/g,"x");return e===""&&(e="?"),e}function ee(s,e=""){let o=s.attrs||{},t=[],r=new RegExp(e,"i");for(let n of Object.keys(o)){let d=n,a=o[n],i=[`${d}:${a}`,`${d}=${a}`];if(e.trim()===""||i.some(c=>r.test(c))){let c=a;d===k?c=a.replace(/\s/gm,""):c=a.replace(/(\r\n|\n|\r)/gm," "),t.push({key:d,value:c})}}return t}function te(s,e,o=""){let t=e.groupNodeAttributes?.[s.id.replace("___group___","")]||{},r=[],n=new RegExp(o,"i");for(let d of Object.keys(t)){let a=d,i=t[d],c=[`${a}:${i}`,`${a}=${i}`];if(o.trim()===""||c.some(l=>n.test(l))){let l=i.replace(/(\r\n|\n|\r)/gm," ");r.push({key:a,value:l})}}return r}function ge(s,e){let o=s.incomingEdges||[],t=[];for(let r=0;r<Math.min(R,o.length);r++){let n=o[r],d=n.sourceNodeId,a=e.nodesById[d],i=fe((a.outputsMetadata||{})[n.sourceNodeOutputId]),c=(s.inputsMetadata||{})[n.targetNodeInputId]||{};t.push({key:Ge(r,a,c),value:i})}if(o.length>R){let r=o.length-R;t.push({key:`(${r} more input${r===1?"":"s"} omitted)`,value:"..."})}return t}function Ne(s){let e=[],o=s.outputsMetadata||{},t=Object.values(o);for(let r=0;r<Math.min(R,t.length);r++){let n=t[r],d=fe(n);e.push({key:xe(r,n,s),value:d})}if(t.length>R){let r=t.length-R;e.push({key:`(${r} more output${r===1?"":"s"} omitted)`,value:"..."})}return e}function me(s,e,o,t){let r=[],n=Object.keys(o).filter(a=>o[a].selected).filter(a=>a.startsWith(M)).map(a=>a.replace(M,"")),d=Object.values(t).filter(a=>n.includes(a.runName));for(let a of d){let i=(a.results||{})?.[e][s.id]?.strValue||"-";r.push({key:a.runName,value:i})}return r}function Ee(s,e){let o=s.split("/"),t=e.split("/"),r="";for(let n=Math.min(o.length,t.length);n>0;n--){let d=o.slice(0,n).join("/"),a=t.slice(0,n).join("/");if(d===a){r=a;break}}return r}function oe(s,e){if(s===e)return"";let o=s.split("/").filter(r=>r!==""),t=e.split("/").filter(r=>r!=="");return t.length===0?"":t[o.length]}var B=36,Y=16,Ie=26,be=50,De=24,Se=80,Le=8,y=class{constructor(e,o,t,r,n=!1){this.modelGraph=e;this.dagre=o;this.showOnNodeItemTypes=t;this.nodeDataProviderRuns=r;this.testMode=n;this.dagreGraph=new this.dagre.graphlib.Graph}dagreGraph;layout(e){let o,t=[];e==null?t=this.modelGraph.rootNodes:(o=this.modelGraph.nodesById[e],t=(o.nsChildrenIds||[]).map(h=>this.modelGraph.nodesById[h])),this.configLayout(this.dagreGraph);let r=ne(o?.id||"",t,this.modelGraph,this.showOnNodeItemTypes,this.nodeDataProviderRuns,this.testMode);for(let h of Object.keys(r.nodes)){let E=r.nodes[h];E.config?.pinToGroupTop||this.dagreGraph.setNode(h,E)}for(let h of Object.keys(r.outgoingEdges))for(let E of r.outgoingEdges[h])this.dagreGraph.setEdge(h,E);this.dagre.layout(this.dagreGraph);let n=Number.MAX_VALUE,d=Number.MAX_VALUE,a=Number.NEGATIVE_INFINITY,i=Number.NEGATIVE_INFINITY;for(let h of t){let E=r.nodes[h.id];if(!E){console.warn(`Node "${h.id}" is not in the dagre layout result`);continue}h.x=(E.x||0)-E.width/2,h.y=(E.y||0)-E.height/2,h.width=E.width,h.height=E.height,h.localOffsetX=0,h.localOffsetY=0,E.config?.pinToGroupTop||(n=Math.min(n,h.x),d=Math.min(d,h.y),a=Math.max(a,h.x+h.width),i=Math.max(i,h.y+h.height))}let c=Number.MAX_VALUE,l=Number.MAX_VALUE,f=Number.NEGATIVE_INFINITY,p=Number.NEGATIVE_INFINITY,u=this.dagreGraph.edges(),m=[];for(let h of u){let E=this.dagreGraph.edge(h).points,I=globalThis.d3,v=globalThis.THREE,V=typeof v>"u"?[]:he(E,I.line,I.curveMonotoneY,v),g=this.modelGraph.nodesById[h.v],b=this.modelGraph.nodesById[h.w];if(g==null){console.warn(`Edge from node not found: "${h.v}"`);continue}if(b==null){console.warn(`Edge to node not found: "${h.w}"`);continue}let C=`${g.id}|${b.id}`;m.push({id:C,fromNodeId:g.id,toNodeId:b.id,points:E,curvePoints:V});for(let O of E)c=Math.min(c,O.x),l=Math.min(l,O.y),f=Math.max(f,O.x),p=Math.max(p,O.y)}if(this.modelGraph.edgesByGroupNodeIds[e||""]=m,c<n)for(let h of t)h.localOffsetX=Math.max(0,n-c);n=Math.min(c,n),a=Math.max(f,a);let _=a-n+P*2;if(o){let h=$(o,this.modelGraph,this.showOnNodeItemTypes,this.nodeDataProviderRuns);if(_<h){let E=(h-_)/2;for(let I of t)I.localOffsetX||(I.localOffsetX=0),I.localOffsetX+=E;_=h}}if(o&&N(o)){let h=_e(o,this.modelGraph,this.showOnNodeItemTypes);if(h>0){let E=h*Q+16;for(let I of t)I.localOffsetY=E;i+=E}}return{x:n,y:d,width:_-P*2,height:i-d}}configLayout(e){e.setGraph({nodesep:20,ranksep:50,edgesep:20,marginx:P,marginy:B}),e.setDefaultEdgeLabel(()=>({}))}};function $(s,e,o,t,r=!1){if(r)return be;let n=s.label,d=G(n,11,N(s))+De;N(s)&&(d+=28);let a=0,i=0;if(T(s)){let l=z(o);for(let u of l){let m=G(`${u}:`,D,!0),_=J(s,u),h=G(_,D,!1);a=Math.max(a,m),i=Math.max(i,h)}if(o["Op node attributes"]?.selected){let u=ee(s,o["Op node attributes"]?.filterRegex||""),m=w(u);a=Math.max(a,m.maxAttrLabelWidth),i=Math.max(i,m.maxAttrValueWidth)}if(o["Op node inputs"]?.selected){let u=ge(s,e),m=w(u);a=Math.max(a,m.maxAttrLabelWidth),i=Math.max(i,m.maxAttrValueWidth)}if(o["Op node outputs"]?.selected){let u=Ne(s),m=w(u);a=Math.max(a,m.maxAttrLabelWidth),i=Math.max(i,m.maxAttrValueWidth)}let f=me(s,e.id,o,t),p=w(f);a=Math.max(a,p.maxAttrLabelWidth),i=Math.max(i,p.maxAttrValueWidth)}else if(N(s)){let l=Z(o);for(let f of l){let p=G(`${f}:`,D,!0),u=J(s,f),m=G(u,D,!1);a=Math.max(a,p),i=Math.max(i,m)}if(o["Layer node attributes"]?.selected){let f=te(s,e,o["Layer node attributes"]?.filterRegex||""),p=w(f);a=Math.max(a,p.maxAttrLabelWidth),i=Math.max(i,p.maxAttrValueWidth)}}i=Math.min(i,ie);let c=a+i+ae*2+K;return c!==K&&(c+=Le*2),Math.max(Se,Math.max(d,c))}function re(s,e,o,t,r=!1,n=!1){if(r)return Ie;if(s.height!=null&&!n)return s.height;let d=0;return T(s)?d=Me(o,s,t):N(s)&&(d=_e(s,e,o)),Ie+d*Q+(d>0?de-4:0)}function ne(s,e,o,t,r,n=!1,d=!1){let a={nodes:{},incomingEdges:{},outgoingEdges:{}};for(let c of e){if(T(c)&&c.hideInLayout)continue;let l={id:c.id,width:c.width||(d?10:$(c,o,t,r,n)),height:d?10:re(c,o,t,r,n),config:T(c)?c.config:void 0};a.nodes[c.id]=l}let i=o.layoutGraphEdges[s]||{};for(let[c,l]of Object.entries(i))for(let f of Object.keys(l)){let p=o.nodesById[c],u=o.nodesById[f];p&&T(p)&&p.config?.pinToGroupTop||u&&T(u)&&u.config?.pinToGroupTop||ve(a,c,f)}return a}function Me(s,e,o){let t=z(s),r=s["Op node attributes"]?.selected?ee(e,s["Op node attributes"]?.filterRegex||"").length:0,n=s["Op node inputs"]?.selected?Object.keys(e.incomingEdges||[]).length:0;n>R&&(n=R+1);let d=s["Op node outputs"]?.selected?Object.keys(e.outputsMetadata||{}).length:0;d>R&&(d=R+1);let a=Object.keys(s).filter(i=>s[i].selected).filter(i=>i.startsWith(M)&&Object.values(o).some(c=>c.runName===i.replace(M,""))).length;return t.length+r+n+d+a}function _e(s,e,o){let t=Z(o),r=o["Layer node attributes"]?.selected?te(s,e,o["Layer node attributes"]?.filterRegex||"").length:0;return t.length+r}function ve(s,e,o){s.outgoingEdges[e]==null&&(s.outgoingEdges[e]=[]),s.outgoingEdges[e].push(o),s.incomingEdges[o]==null&&(s.incomingEdges[o]=[]),s.incomingEdges[o].push(e)}function w(s){let e=0,o=0;for(let{key:t,value:r}of s){let n=G(t,D,!0);e=Math.max(e,n);let d=G(r,D,!1);o=Math.max(o,d)}return{maxAttrLabelWidth:e,maxAttrValueWidth:o}}var S=class{constructor(e,o,t,r,n=!1){this.modelGraph=e;this.dagre=o;this.showOnNodeItemTypes=t;this.nodeDataProviderRuns=r;this.testMode=n}dagreGraphs=[];expandGroupNode(e){let o=this.modelGraph.nodesById[e];if(o&&N(o)){if(o.expanded)return;o.expanded=!0}let t=e;for(;t!=null;){let n=this.modelGraph.nodesById[t];if(!n)break;n.expanded=!0;let d=new y(this.modelGraph,this.dagre,this.showOnNodeItemTypes,this.nodeDataProviderRuns),a=d.layout(t);this.testMode&&this.dagreGraphs.push(d.dagreGraph);let i=a.width+P*2,c=a.height+B+Y;n.pinToTopOpNode&&(c+=this.getPinToTopNodeVerticalSpace(n.pinToTopOpNode)),n.width=i,n.height=c,t=n.nsParentId}let r=new y(this.modelGraph,this.dagre,this.showOnNodeItemTypes,this.nodeDataProviderRuns);r.layout(),this.testMode&&this.dagreGraphs.push(r.dagreGraph);for(let n of this.modelGraph.rootNodes)N(n)&&this.updateNodeOffset(n)}expandFromDeepestGroupNodes(e){let o=new Set,t=[...e];for(;t.length>0;){let d=t.shift();if(o.has(d))continue;o.add(d);let i=this.modelGraph.nodesById[d]?.nsParentId;i&&t.push(i)}let r=Array.from(o).sort((d,a)=>{let i=this.modelGraph.nodesById[d];return this.modelGraph.nodesById[a].level-i.level});for(let d of r){let a=this.modelGraph.nodesById[d];a.expanded=!0;let i=new y(this.modelGraph,this.dagre,this.showOnNodeItemTypes,this.nodeDataProviderRuns),c=i.layout(d);this.testMode&&this.dagreGraphs.push(i.dagreGraph);let l=c.width+P*2,f=c.height+B+Y;a.pinToTopOpNode&&(f+=this.getPinToTopNodeVerticalSpace(a.pinToTopOpNode)),a.width=l,a.height=f}let n=new y(this.modelGraph,this.dagre,this.showOnNodeItemTypes,this.nodeDataProviderRuns);n.layout(),this.testMode&&this.dagreGraphs.push(n.dagreGraph);for(let d of this.modelGraph.rootNodes)N(d)&&this.updateNodeOffset(d)}expandToRevealNode(e){let o=this.modelGraph.nodesById[e],t=[],r=o;for(;;){let d=this.modelGraph.nodesById[r.nsParentId||""];if(!d)break;t.unshift(d),r=d}for(let d of t)this.expandGroupNode(d.id);let n=[];return A(void 0,this.modelGraph,n),n}collapseGroupNode(e){let o=this.modelGraph.nodesById[e];if(!o)return[];o.expanded=!1,delete this.modelGraph.edgesByGroupNodeIds[e],o.width=$(o,this.modelGraph,this.showOnNodeItemTypes,this.nodeDataProviderRuns),o.height=re(o,this.modelGraph,this.showOnNodeItemTypes,this.nodeDataProviderRuns,this.testMode,!0);let t=o.nsParentId;for(;t!=null;){let d=this.modelGraph.nodesById[t];if(!d)break;let a=new y(this.modelGraph,this.dagre,this.showOnNodeItemTypes,this.nodeDataProviderRuns),i=a.layout(t);this.testMode&&this.dagreGraphs.push(a.dagreGraph);let c=i.width+P*2,l=i.height+B+Y;d.pinToTopOpNode&&(l+=this.getPinToTopNodeVerticalSpace(d.pinToTopOpNode)),d.width=c,d.height=l,t=d.nsParentId}let r=new y(this.modelGraph,this.dagre,this.showOnNodeItemTypes,this.nodeDataProviderRuns);r.layout(),this.testMode&&this.dagreGraphs.push(r.dagreGraph);for(let d of this.modelGraph.rootNodes)N(d)&&this.updateNodeOffset(d);let n=[];return A(void 0,this.modelGraph,n),n}reLayoutGraph(e,o){let t=e;if(t)o&&this.clearLayoutData(void 0,!0);else{let r=[];this.clearLayoutData(void 0),A(void 0,this.modelGraph,r),t=r}return t.length>0?this.expandFromDeepestGroupNodes(t):new y(this.modelGraph,this.dagre,this.showOnNodeItemTypes,this.nodeDataProviderRuns).layout(),t}expandAllGroups(){this.clearLayoutData(void 0,!0);let e=this.modelGraph.nodes.filter(o=>N(o)&&(o.nsChildrenIds||[]).filter(t=>N(this.modelGraph.nodesById[t])).length===0).map(o=>o.id);return e.length>0&&this.expandFromDeepestGroupNodes(e),e}collapseAllGroup(){this.clearLayoutData(void 0,!0),new y(this.modelGraph,this.dagre,this.showOnNodeItemTypes,this.nodeDataProviderRuns).layout();for(let o of this.modelGraph.rootNodes)N(o)&&this.updateNodeOffset(o);return[]}updateNodeOffset(e){for(let o of e.nsChildrenIds||[]){let t=this.modelGraph.nodesById[o];t.x!=null&&t.y!=null&&(t.globalX=(e.x||0)+(e.globalX||0)+(t.localOffsetX||0),t.globalY=(e.y||0)+(e.globalY||0)+(t.localOffsetY||0),e.pinToTopOpNode&&t.id!==e.pinToTopOpNode.id&&(t.globalY+=this.getPinToTopNodeVerticalSpace(e.pinToTopOpNode)),e.pinToTopOpNode?.id===t.id&&(t.globalX=(e.x||0)+(e.globalX||0)+(e.width||0)/2,t.globalY=(e.y||0)+(e.globalY||0)+(t.localOffsetY||0)+this.getPinToTopNodeVerticalSpace(t)-(t.height||0)/2+10)),N(t)&&this.updateNodeOffset(t)}}clearLayoutData(e,o){let t=[];e==null?t=this.modelGraph.rootNodes.map(r=>r.id):t=e.nsChildrenIds||[],o&&e!=null&&(e.expanded=!1,delete this.modelGraph.edgesByGroupNodeIds[e.id]);for(let r of t){let n=this.modelGraph.nodesById[r];n&&(n.width=void 0,n.height=void 0,N(n)&&n.expanded&&this.clearLayoutData(n,o))}}getPinToTopNodeVerticalSpace(e){return(e.height||0)+20}};function x(s,e,o){let t={eventType:8,paneId:s,label:e,error:o};postMessage(t)}var Be=/dense<([^>]*)>/,H=class{constructor(e,o,t,r={},n={},d=ce,a=!1,i=!1,c=!1){this.paneId=e;this.graph=o;this.config=t;this.showOnNodeItemTypes=r;this.nodeDataProviderRuns=n;this.groupNodeChildrenCountThreshold=d;this.testMode=a;this.flattenLayers=i;this.keepLayersWithASingleChild=c;this.nodeLabelsToHide=new Set((this.config?.nodeLabelsToHide||[]).map(l=>l.toLowerCase()))}nodeLabelsToHide;process(){let e=this.createEmptyModelGraph();return this.processNodes(e),this.processEdgeRelationships(e),x(this.paneId,"Processing nodes and edges"),this.processNamespaceRelationships(e),x(this.paneId,"Processing layer namespaces"),this.generateLayoutGraphConnections(e),x(this.paneId,"Processing layout data"),this.splitLargeGroupNodes(e),x(this.paneId,"Splitting large layers (if any)"),this.populateDescendantsAndCounts(e),e}processNodes(e){let o=new Set;for(let t of this.graph.nodes){let n=t.namespace.split(";").filter(a=>a!=="");n.length>1&&(t.namespace=n[n.length-1]);let d={nodeType:0,id:t.id,namespace:this.flattenLayers?"":t.namespace,savedNamespace:t.namespace,label:t.label,level:this.getNonEmptyNamespaceComponents(t.namespace).length};if(t.subgraphIds&&t.subgraphIds.length>0&&(d.subgraphIds=t.subgraphIds),this.nodeLabelsToHide.has(t.label.toLowerCase())&&(d.hideInLayout=!0),t.attrs){let a={};for(let i of t.attrs)a[i.key]=this.processAttrValue(i.key,i.value);d.attrs=a}if(t.inputsMetadata&&(d.inputsMetadata=this.processMetadataList(t.inputsMetadata)),t.outputsMetadata&&(d.outputsMetadata=this.processMetadataList(t.outputsMetadata)),t.style&&(d.style=t.style),t.config&&(d.config=t.config),e.nodes.push(d),e.nodesById[d.id]=d,!d.hideInLayout&&!this.flattenLayers){let a=this.getAncestorNamespaces(d.namespace);for(let i of a){if(o.has(i))continue;o.add(i);let c=i.split("/"),l=c.splice(-1)[0],f=c.join("/"),p={nodeType:1,id:this.getGroupNodeIdFromNamespace(i),namespace:f,label:l,level:c.length,expanded:!1};e.nodes.push(p),e.nodesById[p.id]=p}}}}processEdgeRelationships(e){for(let o of this.graph.nodes){let t=e.nodesById[o.id];if(t)for(let r of o.incomingEdges||[]){let n=r.sourceNodeId,d=e.nodesById[n];d&&(t.incomingEdges==null&&(t.incomingEdges=[]),t.incomingEdges.find(a=>a.sourceNodeId===n&&a.sourceNodeOutputId===r.sourceNodeOutputId&&a.targetNodeInputId===r.targetNodeInputId)==null&&t.incomingEdges.push({...r}),d.outgoingEdges==null&&(d.outgoingEdges=[]),d.outgoingEdges.find(a=>a.targetNodeId===t.id&&a.sourceNodeOutputId===r.sourceNodeOutputId&&a.targetNodeInputId===r.targetNodeInputId)==null&&d.outgoingEdges.push({targetNodeId:t.id,sourceNodeOutputId:r.sourceNodeOutputId,targetNodeInputId:r.targetNodeInputId}))}}}processNamespaceRelationships(e){for(let o of e.nodes){if(T(o)&&o.hideInLayout)continue;let t=o.namespace;if(t===""){e.rootNodes.push(o);continue}let r=this.getGroupNodeIdFromNamespace(t),n=e.nodesById[r];n?o.nsParentId=n.id:console.warn(`Failed to find the NS parent of node "${o.id}": "${r}"`),n&&(n.nsChildrenIds==null&&(n.nsChildrenIds=[]),n.nsChildrenIds.includes(o.id)||(n.nsChildrenIds.push(o.id),T(o)&&o.config?.pinToGroupTop&&(n.pinToTopOpNode=o)))}if(!this.keepLayersWithASingleChild)for(;;){let o=0;for(let t of e.nodes)if(N(t)&&t.nsChildrenIds!=null&&t.nsChildrenIds.length===1){let r=e.nodesById[t.nsChildrenIds[0]];if(T(r)){o++;let n=e.nodes.indexOf(t);n>=0&&e.nodes.splice(n,1),delete e.nodesById[t.id];let d=r.namespace,a=this.getNonEmptyNamespaceComponents(d);a.pop(),r.namespace=a.join("/"),r.savedNamespace=r.namespace,r.level=a.length,r.nsParentId=t.nsParentId;let i=e.rootNodes.indexOf(t);if(i>=0&&(e.rootNodes.splice(i,1),e.rootNodes.push(r)),t.nsParentId){let c=e.nodesById[t.nsParentId],l=c.nsChildrenIds.indexOf(t.id);c.nsChildrenIds.splice(l,1),c.nsChildrenIds.push(r.id)}}}if(o===0)break}}generateLayoutGraphConnections(e){e.layoutGraphEdges={};let o=[];for(let n of e.nodes){if(!T(n)||n.hideInLayout)continue;(n.incomingEdges||[]).filter(a=>!e.nodesById[a.sourceNodeId].hideInLayout).length===0&&o.push(n)}let t=[...o],r=new Set;for(;t.length>0;){let n=t.shift();if(n==null||n.hideInLayout||r.has(n.id))continue;r.add(n.id);let d=n.outgoingEdges||[];for(let a of d){let i=e.nodesById[a.targetNodeId];if(i.hideInLayout)continue;let c=Ee(n.namespace,i.namespace),l=oe(c,n.namespace),f=l===""?n.id:`${c}${c===""?"":"/"}${l}___group___`,p=oe(c,i.namespace),u=p===""?i.id:`${c}${c===""?"":"/"}${p}___group___`,m=c===""?"":`${c}___group___`;e.layoutGraphEdges[m]==null&&(e.layoutGraphEdges[m]={}),e.layoutGraphEdges[m][f]==null&&(e.layoutGraphEdges[m][f]={}),e.layoutGraphEdges[m][f][u]=!0}for(let a of d){let i=e.nodesById[a.targetNodeId];t.push(i)}}}splitLargeGroupNodes(e){let o=[void 0],t=!1;for(;o.length>0;){let r=o.shift(),n=r==null?e.rootNodes:(r.nsChildrenIds||[]).map(d=>e.nodesById[d]);if(n.length>this.groupNodeChildrenCountThreshold){t=!0;let d=ne(r?.id||"",n,e,this.showOnNodeItemTypes,this.nodeDataProviderRuns,this.testMode,!0),a=[];for(let u of Object.keys(d.nodes))d.incomingEdges[u]==null&&a.push(e.nodesById[u]);let i=[],c=[],l=new Set,f=u=>{if(l.has(u))return;l.add(u);let m=e.nodesById[u];c.push(m),c.length===this.groupNodeChildrenCountThreshold&&(i.push(c),c=[]);for(let _ of d.outgoingEdges[m.id]||[])f(_)};for(let u of a)f(u.id);c.length<this.groupNodeChildrenCountThreshold&&c.length>0&&i.push(c);let p=[];for(let u=0;u<i.length;u++){let m=i[u],_=r==null?"":`${r.namespace}/${r.label}`,h=`section_${u+1}_of_${i.length}`,E=r==null?`${h}___group___`:`${_}/${h}___group___`,I={nodeType:1,id:E,label:h,namespace:_,level:_.split("/").filter(g=>g!=="").length,nsParentId:r?.id,nsChildrenIds:m.map(g=>g.id),expanded:!1,sectionContainer:!0};p.push(I),e.nodes.push(I),e.nodesById[I.id]=I,e.artificialGroupNodeIds==null&&(e.artificialGroupNodeIds=[]),e.artificialGroupNodeIds.push(I.id);for(let g of m)g.nsParentId=I.id;let v=E.replace("___group___",""),V=g=>{if(g.namespace===""?g.namespace=v:r==null?g.namespace=`${v}/${g.namespace}`:g.namespace=(g.nsParentId||"").replace("___group___",""),g.level=g.namespace.split("/").filter(C=>C!=="").length,N(g)){let C=g.id;if(delete e.nodesById[g.id],g.id=`${g.namespace}/${g.label}___group___`,e.nodesById[g.id]=g,g.nsParentId){let O=e.nodesById[g.nsParentId],L=(O.nsChildrenIds||[]).indexOf(C);L>=0&&((O.nsChildrenIds||[])[L]=g.id)}for(let O of g.nsChildrenIds||[]){let L=e.nodesById[O];L!=null&&(L.nsParentId=g.id,V(L))}}};for(let g of m)V(g);if(r==null){for(let g of m){let b=e.rootNodes.indexOf(g);b>=0&&e.rootNodes.splice(b,1)}I.namespace===""&&e.rootNodes.push(I)}n=p}r!=null&&(r.nsChildrenIds=p.map(u=>u.id))}for(let d of n)N(d)&&o.push(d)}t&&this.generateLayoutGraphConnections(e)}populateDescendantsAndCounts(e){let o=Number.MAX_VALUE,t=Number.NEGATIVE_INFINITY;for(let r of e.nodes)if(N(r)){let n=[];this.gatherDescendants(e,r,n),r.descendantsNodeIds=n.map(a=>a.id),r.descendantsOpNodeIds=n.filter(a=>a.nodeType===0).map(a=>a.id);let d=(r.descendantsOpNodeIds||[]).length;o=Math.min(d,o),t=Math.max(d,t)}e.minDescendantOpNodeCount=o,e.maxDescendantOpNodeCount=t}createEmptyModelGraph(){let e={id:this.graph.id,collectionLabel:this.graph.collectionLabel||"",nodes:[],nodesById:{},rootNodes:[],edgesByGroupNodeIds:{},layoutGraphEdges:{},minDescendantOpNodeCount:-1,maxDescendantOpNodeCount:-1};return this.graph.groupNodeAttributes&&(e.groupNodeAttributes=this.graph.groupNodeAttributes),e}getAncestorNamespaces(e){let o=this.getNonEmptyNamespaceComponents(e),t=[];for(;o.length>0;)t.push(o.join("/")),o.pop();return t}getNonEmptyNamespaceComponents(e){return e.split("/").filter(o=>o!=="")}getGroupNodeIdFromNamespace(e){return`${e}___group___`}gatherDescendants(e,o,t){for(let r of o.nsChildrenIds||[]){let n=e.nodesById[r];(N(n)||T(n)&&!n.hideInLayout)&&t.push(n),N(n)&&this.gatherDescendants(e,n,t)}}processAttrValue(e,o){if(o.startsWith("dense<")){let t=o.match(Be);if(t!=null&&t.length>1){let r=t[1];return Te(r)}}else if(e===k)return Te(o);return o.replaceAll('"',"")||"<empty>"}processMetadataList(e){let o={};for(let t of e){let r={};for(let n of t.attrs){let d=n.key,a=n.value;d==="tensor_shape"&&(d="shape",a=a.replace("tensor<","").replace(">","").replace("*","\u2217").split("x").join(" x ")),r[d]=a}o[t.id]=r}return o}};function Te(s){try{return JSON.stringify(JSON.parse(s),null,2).replaceAll("\\n",`
`).trim()}catch{return s}}var F=10000019,W=class{constructor(e){this.modelGraph=e}markIdenticalGroups(){let e={};for(let t of this.modelGraph.nodes){if(!N(t))continue;let r=0,n=(t.descendantsOpNodeIds||[]).map(a=>this.modelGraph.nodesById[a]).filter(a=>!a.hideInLayout),d=new Set(n.map(a=>a.id));for(let a of n)r=(r+this.getNodeHash(a,d))%F;for(let a of n)for(let i of a.outgoingEdges||[]){let c=i.targetNodeId;if(!d.has(c))continue;let l=this.modelGraph.nodesById[c];r=(r+this.getEdgeHash(a,l))%F}e[r]||(e[r]=[]),e[r].push(t)}let o=0;for(let t of Object.values(e))if(!(t.length<=1)&&!(t.length===2&&(t[0].nsParentId===t[1].id||t[1].nsParentId===t[0].id))){for(let r of t)r.identicalGroupIndex=o;o++}}getNodeHash(e,o){let t=0;t=this.addToHash(t,e.label);let r=0;for(let d of e.incomingEdges||[]){let a=d.sourceNodeId;if(o.has(a)){let i=this.modelGraph.nodesById[a];t=this.addToHash(t,`in ${i.label}`),r++}}let n=0;for(let d of e.outgoingEdges||[]){let a=d.targetNodeInputId;if(o.has(a)){let i=this.modelGraph.nodesById[a];t=this.addToHash(t,`out ${i.label}`),n++}}return t=this.addToHash(t,`${r}`),t=this.addToHash(t,`${n}`),t}getEdgeHash(e,o){return this.genHash(e.label+o.label)%F}genHash(e){let o=5381;e=e||"";for(let t=0,r=e.length;t<r;t++)o+=(o<<5)+e.charCodeAt(t);return o&2147483647}addToHash(e,o){return(e+this.genHash(o))%F}};try{importScripts("/static_files/worker_deps.js")}catch(s){console.error(`Failed to import libs: ${s}`)}var se={};self.addEventListener("message",s=>{let e=s.data;switch(e.eventType){case 0:{let o=Ue(e.paneId,e.graph,e.showOnNodeItemTypes,e.nodeDataProviderRuns,e.config,e.groupNodeChildrenCountThreshold,e.flattenLayers,e.keepLayersWithASingleChild);U(o,e.paneId);let t={eventType:1,modelGraph:o,paneId:e.paneId};postMessage(t);break}case 9:{let o=X(e.modelGraphId,e.paneId),t=JSON.parse(JSON.stringify(o));U(t,e.rendererId);let r={eventType:10,modelGraph:o,paneId:e.paneId,rendererId:e.rendererId,groupNodeId:e.groupNodeId,initialPosition:e.initialPosition};postMessage(r);break}case 2:{let o=X(e.modelGraphId,e.rendererId),t=[];e.expand?t=Ve(o,e.groupNodeId,e.showOnNodeItemTypes,e.nodeDataProviderRuns,e.all===!0):t=ke(o,e.groupNodeId,e.showOnNodeItemTypes,e.nodeDataProviderRuns,e.all===!0),U(o,e.rendererId);let r={eventType:3,modelGraph:o,expanded:e.expand,groupNodeId:e.groupNodeId,rendererId:e.rendererId,deepestExpandedGroupNodeIds:t};postMessage(r);break}case 4:{let o=X(e.modelGraphId,e.rendererId);Ye(o,e.showOnNodeItemTypes,e.nodeDataProviderRuns,e.targetDeepestGroupNodeIdsToExpand,e.clearAllExpandStates),U(o,e.rendererId);let t={eventType:5,modelGraph:o,selectedNodeId:e.selectedNodeId,rendererId:e.rendererId,forRestoringUiState:e.forRestoringUiState,rectToZoomFit:e.rectToZoomFit,forRestoringSnapshotAfterTogglingFlattenLayers:e.forRestoringSnapshotAfterTogglingFlattenLayers,targetDeepestGroupNodeIdsToExpand:e.targetDeepestGroupNodeIdsToExpand};postMessage(t);break}case 6:{let o=X(e.modelGraphId,e.rendererId),t=$e(o,e.showOnNodeItemTypes,e.nodeDataProviderRuns,e.nodeId);U(o,e.rendererId);let r={eventType:7,modelGraph:o,nodeId:e.nodeId,rendererId:e.rendererId,deepestExpandedGroupNodeIds:t,noNodeShake:e.noNodeShake,select:e.select};postMessage(r);break}case 11:{se={};break}default:break}});function Ue(s,e,o,t,r,n,d,a){let i,l=new H(s,e,r,o,{},n,!1,d,a).process();if(l.nodesById[""]!=null&&(i="Some nodes have empty strings as ids which will cause layout failures. See console for details.",console.warn("Nodes with empty ids",l.nodesById[""])),!i){let p=new y(l,dagre,o,t);try{p.layout()}catch(u){i=`Failed to layout graph: ${u}`}}return x(s,"Laying out root layer",i),new W(l).markIdenticalGroups(),x(s,"Finding identical layers"),l}function Ve(s,e,o,t,r){let n=new S(s,dagre,o,t);if(e!=null){let d,a=s.nodesById[e];if(a&&N(a)){a.expanded=!0;let c=a;for(;;){let f=c.nsChildrenIds||[];if(f.length===1){let p=s.nodesById[f[0]];if(p&&N(p))p.expanded=!0,c=p;else break}else break}let l=[];A(c,s,l),d=l.length===0?[c.id]:l;for(let f of c.descendantsNodeIds||[]){let p=s.nodesById[f];p.width=void 0,p.height=void 0}}if(r){for(let c of a.descendantsNodeIds||[]){let l=s.nodesById[c];N(l)&&(l.expanded=!0)}d=void 0}n.reLayoutGraph(d);let i=[];return A(void 0,s,i),i}else return n.expandAllGroups()}function ke(s,e,o,t,r){let n=new S(s,dagre,o,t);if(e!=null){if(r){let d=s.nodesById[e];for(let a of d.descendantsNodeIds||[]){let i=s.nodesById[a];N(i)&&(i.expanded=!1,i.width=void 0,i.height=void 0,delete s.edgesByGroupNodeIds[i.id])}}return n.collapseGroupNode(e)}else return n.collapseAllGroup()}function Ye(s,e,o,t,r){new S(s,dagre,e,o).reLayoutGraph(t,r)}function $e(s,e,o,t){return new S(s,dagre,e,o).expandToRevealNode(t)}function U(s,e){se[ye(s.id,e)]=s}function X(s,e){let o=se[ye(s,e)];if(o==null)throw new Error(`ModelGraph with id "${s}" not found for rendererId "${e}"`);return o}function ye(s,e){return`${s}___${e}`}
